<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIRTUAL ATELIER - AI 虚拟试衣间</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1a1a1a; overflow-x: hidden; }
        @keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanning::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(to right, transparent, #000, transparent); animation: scan 2s linear infinite; opacity: 0.5; }
        .dashed-upload-box { border: 1px dashed #cccccc; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .dashed-upload-box.drag-over { border-color: #000; background-color: #f9f9f9; transform: scale(1.02); }
        .upload-preview { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 10; }
        .image-card { transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .image-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.05); }
        .aspect-2by3 { aspect-ratio: 2 / 3; }
        .modal-animate { animation: modalFadeIn 0.3s ease-out; }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .page-transition { transition: opacity 0.3s ease; }
        .hidden-page { display: none; opacity: 0; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-7xl mx-auto border-t border-gray-200">
        <!-- 顶部导航栏 -->
        <header class="p-4 border-b border-gray-100">
            <div class="flex justify-between items-center text-sm font-medium">
                <div class="flex space-x-8 uppercase">
                    <a href="javascript:window.showPage('studio')" class="text-black tracking-[0.2em] text-xl font-bold italic">VIRTUAL ATELIER</a>
                </div>
                <div class="flex space-x-8 text-gray-400">
                    <button id="nav-studio" onclick="window.showPage('studio')" class="text-black border-b-2 border-black pb-1 transition-all">STUDIO</button>
                    <button id="nav-archive" onclick="window.showPage('archive')" class="hover:text-black transition-all">ARCHIVE</button>
                    <button class="hover:text-black transition-colors cursor-not-allowed uppercase">Collections</button>
                </div>
                <div class="flex items-center space-x-5">
                    <button class="hover:opacity-60 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                    <button class="hover:opacity-60 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg></button>
                </div>
            </div>
        </header>

        <!-- STUDIO 页面 -->
        <main id="page-studio" class="page-transition flex flex-col lg:flex-row min-h-[calc(100vh-65px)]">
            <div class="lg:w-1/2 p-8 lg:p-12 border-r border-gray-100 bg-[#fafafa]">
                <div class="max-w-md mx-auto">
                    <h2 class="text-sm tracking-[0.3em] font-bold mb-1 text-gray-400 uppercase">Step 01</h2>
                    <h1 class="text-2xl font-bold mb-8 italic">Upload Your Wardrobe</h1>
                    <div id="upload-grid" class="grid grid-cols-2 gap-6">
                        <script>
                            for(let i=0; i<4; i++) {
                                document.write(`
                                    <div class="upload-slot group">
                                        <input type="file" class="hidden" id="file-input-${i}" data-index="${i}" accept="image/*" onchange="window.handleFileChange(this)">
                                        <div class="dashed-upload-box w-full aspect-square bg-white flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:shadow-sm" 
                                             id="upload-box-${i}" onclick="document.getElementById('file-input-${i}').click()"
                                             ondragover="window.handleDragOver(event, ${i})" ondragleave="window.handleDragLeave(event, ${i})" ondrop="window.handleDrop(event, ${i})">
                                            <div class="transition-transform group-hover:scale-110 duration-300 flex flex-col items-center z-20" id="icon-container-${i}">
                                                <svg class="w-6 h-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.2" d="M12 4v16m8-8H4"></path></svg>
                                                <p class="text-[10px] tracking-widest uppercase">Select Item</p>
                                            </div>
                                            <img id="preview-${i}" class="upload-preview hidden" src="" alt="Preview">
                                        </div>
                                    </div>
                                `);
                            }
                        </script>
                    </div>
                    <div class="mt-12">
                        <button id="generate-button" class="w-full h-14 bg-black text-white text-xs font-bold tracking-[0.2em] uppercase hover:bg-zinc-800 transition-all disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed flex items-center justify-center" onclick="window.handleGenerateLook()">
                            <svg id="loading-spinner-btn" class="animate-spin h-4 w-4 text-white mr-3 hidden" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span id="button-text">Generate Look</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="lg:w-1/2 p-8 lg:p-12 bg-white">
                <div class="max-w-2xl mx-auto">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h2 class="text-sm tracking-[0.3em] font-bold mb-1 text-gray-400 uppercase">Step 02</h2>
                            <h1 class="text-2xl font-bold italic">A.I. Lookbook</h1>
                        </div>
                        <button id="download-all-btn" onclick="window.downloadCurrentLookbook()" class="hidden text-[10px] tracking-widest font-bold uppercase border border-black px-4 py-2 hover:bg-black hover:text-white transition-all">Save Full Lookbook</button>
                    </div>
                    <div id="results-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-6 mb-12"></div>
                    <div id="status-container" class="opacity-0 transition-opacity duration-500">
                        <div class="flex justify-between items-end mb-2">
                            <p id="generating-status" class="text-[10px] font-bold tracking-widest uppercase text-black">Processing</p>
                            <p id="progress-percent" class="text-[10px] font-mono text-gray-400">0%</p>
                        </div>
                        <div class="w-full bg-gray-100 h-[1px]"><div id="progress-bar" class="bg-black h-[1px] transition-all duration-700 ease-out" style="width: 0%;"></div></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ARCHIVE 页面 -->
        <main id="page-archive" class="page-transition hidden-page p-8 lg:p-12 min-h-[calc(100vh-65px)]">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-baseline mb-12 border-b border-gray-100 pb-8">
                    <h1 class="text-3xl font-bold italic">Archive History</h1>
                    <div class="flex items-center space-x-4">
                        <button onclick="window.clearAllArchive()" class="text-[9px] tracking-widest text-red-400 uppercase hover:underline">Clear All</button>
                        <p class="text-[10px] tracking-widest text-gray-400 uppercase font-mono">IDB STORAGE</p>
                    </div>
                </div>
                <div id="archive-list" class="space-y-16">
                    <div class="text-center py-20 text-gray-300 italic tracking-widest uppercase">Initializing Database...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- 模态框与Toast -->
    <div id="image-modal" class="fixed inset-0 bg-white/95 backdrop-blur-sm hidden items-center justify-center p-6 z-50 cursor-zoom-out" onclick="window.closeModal()">
        <div class="max-w-3xl w-full flex flex-col items-center modal-animate" onclick="event.stopPropagation()">
            <img id="modal-image" src="" alt="Zoomed" class="max-h-[80vh] w-auto shadow-2xl rounded-sm">
            <button class="mt-8 text-[10px] tracking-[0.4em] uppercase font-bold border-b border-black pb-1 hover:opacity-50 transition" onclick="window.closeModal()">Close View</button>
        </div>
    </div>
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] tracking-widest uppercase px-6 py-3 rounded-full opacity-0 pointer-events-none transition-all duration-300 z-50">Message</div>

    <script type="module">
        const MODEL_NAME = 'gemini-2.5-flash-image-preview'; 
        const apiKey = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        const generateButton = document.getElementById('generate-button');
        const buttonText = document.getElementById('button-text');
        const resultsGrid = document.getElementById('results-grid');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const generatingStatus = document.getElementById('generating-status');
        const statusContainer = document.getElementById('status-container');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const archiveList = document.getElementById('archive-list');

        let uploadedItems = [null, null, null, null]; 
        let currentLookbookImages = []; 
        let currentSessionId = null;
        let dbInstance = null;

        // --- 数据库逻辑增强 ---
        async function initDB() {
            if (dbInstance) return dbInstance;
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('VAtelierDB_V3', 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('history')) {
                        db.createObjectStore('history', { keyPath: 'id' });
                    }
                };
                request.onsuccess = (e) => {
                    dbInstance = e.target.result;
                    console.log("Database connection established.");
                    resolve(dbInstance);
                };
                request.onblocked = () => {
                    console.warn("Database blocked. Please close other tabs.");
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function saveToDB(entry) {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['history'], 'readwrite');
                const store = transaction.objectStore('history');
                const request = store.put(entry); // 使用 put 替代 add 确保可以覆盖/更新
                transaction.oncomplete = () => {
                    console.log("Session saved to DB:", entry.id);
                    resolve();
                };
                transaction.onerror = (e) => reject(e.target.error);
            });
        }

        async function getAllFromDB() {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['history'], 'readonly');
                const store = transaction.objectStore('history');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result.sort((a, b) => b.id - a.id));
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // --- 界面交互 ---
        window.showPage = (pageId) => {
            ['studio', 'archive'].forEach(p => {
                document.getElementById(`page-${p}`).classList.toggle('hidden-page', p !== pageId);
                const nav = document.getElementById(`nav-${p}`);
                if(nav) {
                    nav.className = p === pageId ? "text-black border-b-2 border-black pb-1 transition-all" : "hover:text-black transition-all text-gray-400";
                }
            });
            if (pageId === 'archive') renderArchive();
        };

        window.handleFileChange = function(input) {
            const idx = parseInt(input.dataset.index);
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedItems[idx] = e.target.result; 
                    const preview = document.getElementById(`preview-${idx}`);
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    document.getElementById(`icon-container-${idx}`).classList.add('opacity-0');
                    const count = uploadedItems.filter(i => i).length;
                    generateButton.disabled = count === 0;
                    buttonText.textContent = count > 0 ? `Generate Look` : "Select Items";
                };
                reader.readAsDataURL(file);
            }
        };

        window.handleGenerateLook = async function() {
            const inputs = uploadedItems.filter(i => i);
            if (inputs.length === 0) return;
            
            currentLookbookImages = [];
            currentSessionId = Date.now();
            downloadAllBtn.classList.add('hidden');
            generateButton.disabled = true;
            document.getElementById('loading-spinner-btn').classList.remove('hidden');
            resultsGrid.innerHTML = '';
            statusContainer.classList.remove('opacity-0');
            
            const configs = [
                { title: "Frontal", view: "full frontal view" },
                { title: "Profile", view: "side profile view" },
                { title: "Low Angle", view: "dramatic low angle shot" },
                { title: "High Angle", view: "chic high angle from above" },
                { title: "Details", view: "high-fashion torso close-up" }
            ];

            configs.forEach((c, idx) => resultsGrid.appendChild(createPlaceholder(c.title, `res-${idx}`)));

            for (let i = 0; i < configs.length; i++) {
                const c = configs[i];
                generatingStatus.textContent = `Developing: ${c.title}`;
                const p = Math.floor((i / configs.length) * 100);
                progressBar.style.width = `${p}%`;
                progressPercent.textContent = `${p}%`;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: `Professional model wearing uploaded clothes, minimalist style, white background, ${c.view}` }, ...inputs.map(img => ({ inlineData: { mimeType: "image/png", data: img.split(',')[1] } }))] }],
                        generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
                    };
                    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const data = await res.json();
                    const b64 = data?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    
                    if (b64) {
                        const url = `data:image/png;base64,${b64}`;
                        currentLookbookImages.push({ title: c.title, url });
                        renderImage(`res-${i}`, url);
                    }
                } catch (e) { 
                    console.error("API Error at " + c.title, e); 
                }
            }

            // 核心存储逻辑：确保在按钮恢复前数据已写入数据库
            if (currentLookbookImages.length > 0) {
                const entry = { 
                    id: currentSessionId, 
                    timestamp: new Date().toLocaleString(), 
                    inputs: [...inputs],
                    outputs: [...currentLookbookImages] 
                };
                await saveToDB(entry);
                downloadAllBtn.classList.remove('hidden');
                showToast("Lookbook Saved to Archive");
            }

            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            generatingStatus.textContent = "Finished";
            generateButton.disabled = false;
            document.getElementById('loading-spinner-btn').classList.add('hidden');
            setTimeout(() => statusContainer.classList.add('opacity-0'), 2500);
        };

        async function renderArchive() {
            archiveList.innerHTML = `<div class="text-center py-20 text-gray-300 italic tracking-widest uppercase animate-pulse">Loading Archive Database...</div>`;
            try {
                const history = await getAllFromDB();
                if (!history || history.length === 0) {
                    archiveList.innerHTML = `<div class="text-center py-20 text-gray-300 italic tracking-widest uppercase">No Archive Records Found</div>`;
                    return;
                }
                archiveList.innerHTML = history.map(entry => `
                    <div class="group border-b border-gray-100 pb-12">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                            <div>
                                <p class="text-[9px] tracking-widest text-gray-400 uppercase font-mono mb-1">Session ID: ${entry.id}</p>
                                <h3 class="text-xl font-bold italic">${entry.timestamp}</h3>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="window.downloadArchiveById(${entry.id})" class="text-[9px] tracking-[0.2em] font-bold uppercase border border-black px-5 py-2 hover:bg-black hover:text-white transition-all">Download Zip</button>
                                <button onclick="window.deleteEntry(${entry.id})" class="text-[9px] tracking-[0.2em] font-bold uppercase border border-red-100 text-red-300 px-5 py-2 hover:border-red-500 hover:text-red-500 transition-all">Delete</button>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-[8px] tracking-[0.3em] uppercase text-gray-300 font-bold mb-3">Input Items</p>
                            <div class="flex gap-2">
                                ${entry.inputs ? entry.inputs.map(img => `
                                    <div class="w-12 h-12 border border-gray-50 rounded-sm overflow-hidden grayscale hover:grayscale-0 transition-all">
                                        <img src="${img}" class="w-full h-full object-cover">
                                    </div>
                                `).join('') : '<span class="text-gray-200">N/A</span>'}
                            </div>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                            ${entry.outputs.map(out => `
                                <div class="image-card aspect-2by3 bg-gray-50 overflow-hidden cursor-zoom-in">
                                    <img src="${out.url}" class="w-full h-full object-cover" onclick="window.openModal('${out.url}')">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                archiveList.innerHTML = `<div class="text-center py-20 text-red-300 italic">DATABASE READ ERROR</div>`;
            }
        }

        window.downloadArchiveById = async (id) => {
            const history = await getAllFromDB();
            const entry = history.find(h => h.id === id);
            if (!entry) return;
            const zip = new JSZip();
            entry.outputs.forEach((img, idx) => zip.file(`${idx + 1}_${img.title.replace(/\s+/g, '_')}.png`, img.url.split(',')[1], {base64: true}));
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `VAtelier_Lookbook_${id}.zip`;
            link.click();
        };

        window.deleteEntry = async (id) => {
            if (confirm("DELETE THIS SESSION?")) {
                const db = await initDB();
                const transaction = db.transaction(['history'], 'readwrite');
                transaction.objectStore('history').delete(id);
                transaction.oncomplete = () => renderArchive();
            }
        }

        window.clearAllArchive = async () => {
            if (confirm("DANGER: WIPE ALL ARCHIVE DATA?")) {
                const db = await initDB();
                const transaction = db.transaction(['history'], 'readwrite');
                transaction.objectStore('history').clear();
                transaction.oncomplete = () => {
                    renderArchive();
                    showToast("Archive Wiped");
                };
            }
        };

        function createPlaceholder(title, id) {
            const div = document.createElement('div');
            div.className = 'image-card group relative';
            div.innerHTML = `<div id="${id}" class="w-full aspect-2by3 bg-[#fcfcfc] flex flex-col items-center justify-center border border-gray-100 text-gray-300 relative overflow-hidden"><div class="z-10 flex flex-col items-center"><div class="w-4 h-4 border-2 border-gray-200 border-t-black rounded-full animate-spin mb-3"></div><span class="text-[8px] tracking-[0.3em] uppercase font-bold text-gray-400">Rendering</span></div><div class="absolute inset-0 scanning"></div></div><div class="mt-3 flex justify-between px-1"><span class="text-[9px] tracking-widest font-bold uppercase">${title}</span></div>`;
            return div;
        }

        function renderImage(id, url) {
            const el = document.getElementById(id);
            if(el) el.innerHTML = `<img src="${url}" class="w-full h-full object-cover cursor-zoom-in transition-transform duration-700 hover:scale-110" onclick="window.openModal('${url}')">`;
        }

        window.openModal = (url) => { document.getElementById('modal-image').src = url; document.getElementById('image-modal').classList.replace('hidden', 'flex'); };
        window.closeModal = () => { document.getElementById('image-modal').classList.replace('flex', 'hidden'); };
        window.downloadCurrentLookbook = () => {
            if(currentSessionId) window.downloadArchiveById(currentSessionId);
            else showToast("No generated content to download");
        };
        
        function showToast(m) { 
            const t = document.getElementById('toast'); 
            t.textContent = m; 
            t.className = "fixed bottom-8 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] tracking-widest uppercase px-6 py-3 rounded-full opacity-100 transition-all duration-300 z-50"; 
            setTimeout(() => t.classList.add('opacity-0'), 3000); 
        }

        window.handleDragOver = (e, i) => { e.preventDefault(); document.getElementById(`upload-box-${i}`).classList.add('drag-over'); };
        window.handleDragLeave = (e, i) => document.getElementById(`upload-box-${i}`).classList.remove('drag-over');
        window.handleDrop = (e, i) => { e.preventDefault(); document.getElementById(`upload-box-${i}`).classList.remove('drag-over'); const f = e.dataTransfer.files[0]; if(f) { const inp = document.getElementById(`file-input-${i}`); const dt = new DataTransfer(); dt.items.add(f); inp.files = dt.files; window.handleFileChange(inp); } };
    </script>
</body>
</html>